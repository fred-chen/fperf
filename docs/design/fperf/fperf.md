# fperf

- [fperf](#fperf)
  - [Overall](#overall)
  - [Concept](#concept)
    - [STREAM](#stream)
    - [STREAM çš„å†…éƒ¨ç»“æ„](#stream-%E7%9A%84%E5%86%85%E9%83%A8%E7%BB%93%E6%9E%84)
    - [å‘é€æ•°æ®æ—¶çš„è€ƒè™‘](#%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE%E6%97%B6%E7%9A%84%E8%80%83%E8%99%91)
    - [MPRTTï¼ŒNODELAY, QUICKACK](#mprttnodelay-quickack)
      - [MPRTT](#mprtt)
      - [WHY MPRTT](#why-mprtt)
      - [Nagle's Algorithm å’Œ Delayed ACK](#nagles-algorithm-%E5%92%8C-delayed-ack)
      - [Nagle's Algorithm](#nagles-algorithm)
      - [TCP delayed acknowledgment](#tcp-delayed-acknowledgment)
    - [æ—¶å»¶çš„è®¡ç®—](#%E6%97%B6%E5%BB%B6%E7%9A%84%E8%AE%A1%E7%AE%97)
    - [BLOCK å’Œ NONBLOCK](#block-%E5%92%8C-nonblock)
    - [n streams](#n-streams)
  - [å‚æ•°å›çœ‹](#%E5%8F%82%E6%95%B0%E5%9B%9E%E7%9C%8B)

## Overall

fperf å·¥å…·æ—¨åœ¨è¯„ä¼°ç‰¹å®šç½‘ç»œçš„ TCPï¼ŒUDPï¼ŒRDMA çš„å¸¦å®½ï¼ˆbwï¼ŒBandWidthï¼‰åŠå‘é€-æ¥æ”¶å»¶è¿Ÿï¼ˆlatï¼ŒLatencyï¼‰ã€‚

fperf æ˜¯ä¸€ä¸ªClient-Serveræ¶æ„çš„å·¥å…·ã€‚æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯éƒ½å…±ç”¨ä¸€ä¸ªå•ä¸€çš„å¯æ‰§è¡Œæ–‡ä»¶`fperf`ï¼Œfperf çš„ä½¿ç”¨åŸºæœ¬æµç¨‹æ˜¯ï¼š

1. å…ˆåœ¨æœåŠ¡ç«¯ä¸»æœºè¿è¡Œå‘½ä»¤`fperf -s`ï¼Œä»¥å¯åŠ¨æœåŠ¡ï¼›
2. ç„¶ååœ¨å®¢æˆ·ç«¯ä¸»æœºè¿è¡Œå‘½ä»¤`fperf -c <ip_or_hostname_of_the_server>`ï¼Œè¿æ¥æœåŠ¡ç«¯ï¼Œä»¥é»˜è®¤å‚æ•°å¼€å§‹ä¼ è¾“æ•°æ®å¹¶ç”ŸæˆæŠ¥å‘Šã€‚

æœåŠ¡ç«¯çš„è¿è¡Œç»“æœ

```bash=
$ ./fperf -s

Server listening .... new TCP connection from 127.0.0.1:50384. pkt_size(32KB)
received : 10240MB(10.00GB 10737418240B) in 2.83s. (bw: 3.54GB/s 28Gbit/s)
latency  : avg=8.53us   min=1.46us      max=129.76us
```

æœåŠ¡ç«¯æŠ¥å‘Šè§£è¯»ï¼š

- ç¬¬ä¸€è¡Œï¼šæ¥å—åˆ°ä¸€ä¸ªæ–°çš„`TCP`ç±»å‹çš„è¿æ¥ï¼Œå‡†å¤‡ä»¥ 32KB çš„ç¼“å†²åŒºå¤§å°æ¥æ”¶æ•°æ®ï¼›
- ç¬¬äºŒè¡Œï¼šåœ¨2.83ç§’çš„æ—¶é—´å†…æ”¶åˆ°äº†10240MBï¼ˆ10GB) æ•°æ®ï¼Œå¸¦å®½ä¸º28Gbit/sï¼›
- ç¬¬ä¸‰è¡Œï¼šæ—¶å»¶ä¿¡æ¯ï¼Œå¹³å‡æ¥æ”¶æ—¶å»¶8.53å¾®ç§’ï¼Œæœ€å°æ¥æ”¶æ—¶å»¶1.46å¾®ç§’ï¼Œæœ€å¤§æ¥æ”¶æ—¶å»¶129.76å¾®ç§’ã€‚

å®¢æˆ·ç«¯çš„è¿è¡Œç»“æœï¼š

```bash
$ ./fperf -c 127.0.0.1 

TCP CLIENT => 127.0.0.1:28444 pkt_size=32768B sync(no-queue) nsockets=1
sent      : 10240MB(10.00GB 10737418240B) in 2.83s. (bw: 3.54GB/s 28Gbit/s)
latency   : avg=8.62us  min=5.09us      max=74.84us
```

å®¢æˆ·ç«¯æŠ¥å‘Šè§£è¯»ï¼š

- ç¬¬ä¸€è¡Œï¼š`TCP` ç±»å‹çš„å®¢æˆ·ç«¯è¿æ¥åˆ°æœåŠ¡å™¨çš„`28444`ç«¯å£ï¼Œå‡†å¤‡ä»¥ 32768B (32KB) çš„ç¼“å†²åŒºå¤§å°ä¼ è¾“æ•°æ®ï¼›
- ç¬¬äºŒè¡Œï¼šåœ¨2.83ç§’çš„æ—¶é—´å†…å‘é€äº† 10240MB (10GB) æ•°æ®ï¼Œå¸¦å®½ä¸º28Gbit/sï¼›
- ç¬¬ä¸‰è¡Œï¼šæ—¶å»¶ä¿¡æ¯ï¼Œå¹³å‡å‘é€æ—¶å»¶8.62å¾®ç§’ï¼Œæœ€å°å‘é€æ—¶å»¶5.09å¾®ç§’ï¼Œæœ€å¤§å‘é€æ—¶å»¶74.84å¾®ç§’ã€‚

ä¸Šè¿°ä¸ºé»˜è®¤å‚æ•°ä¸‹è¿è¡Œç»“æœçš„æŠ¥å‘Šã€‚å½“ç»™ fperf æŒ‡å®šä¸åŒçš„å‚æ•°æ—¶ï¼ŒæŠ¥å‘Šæ ¼å¼å¯èƒ½ä¸åŒã€‚

fperf å·¥å…·çš„å‘½ä»¤è¡Œå‚æ•°æœ‰ï¼š

```bash=
$ ./fperf -h
'fperf' measures UDP/TCP/RDMA bandwidth and latency.

Usage: fperf --server | --client server_name
  -t, --nstreams n        number of streams
  -n, --nsockets n        number of sockets per stream
  -u, --udp               use UDP  (default TCP)
  -R, --rdma              use RDMA (default TCP)
  -D, --rdmadev devname   RDMA NIC name (use the first found by default)
  -m, --mb n              n MB to send (default 10240 MB)
  -r, --mprtt             'most-practicle-round-trip-time' wait for ack before sending next
  -l, --pktsize           packet size in BYTE (default 32768)
  -q, --qtype             queue type: 1: mutex queue(default), 0: lockfree queue
  -d, --nodelay           for TCP only, add TCP_NODELAY flag to disable nagle's algorithm
  -a, --quickack          for TCP only, add TCP_QUICKACK flag to disable delayed ack algorithm
```

å„ä¸ªå‚æ•°çš„å«ä¹‰ï¼š

 çŸ­æ ¼å¼           | é•¿æ ¼å¼                 | è§£é‡Š
 ----------------|-----------------------|--------------------------
 -s              | --server              | ä½¿ fperf ä»¥æœåŠ¡ç«¯æ¨¡å¼è¿è¡Œ
 -c server_name  | --client server_name  | ä½¿ fperf ä»¥å®¢æˆ·ç«¯æ¨¡å¼è¿è¡Œ
 -n n            | --nsockets n          | åŒä¸€ä¸ªstreamé‡Œå¼€å¯`n`ä¸ª`socket`
 -R              | --rdma                | ä½¿ç”¨`RDMA`åè®®ï¼ˆé»˜è®¤ä½¿ç”¨`TCP`åè®®)
 -D devname      | --rdmadev devname     | ä½¿ç”¨`RDMA`åè®®æ—¶ä½¿ç”¨çš„è®¾å¤‡åï¼ˆé»˜è®¤ä½¿ç”¨ç¬¬ä¸€ä¸ªè¢«å‘ç°çš„RDMAè®¾å¤‡ï¼‰
 -u              | --udp                 | ä½¿ç”¨`UDP`åè®®ï¼ˆé»˜è®¤ä½¿ç”¨`TCP`åè®®)
 -m n            | --mb n                | æ€»å…±ä¼ è¾“ n MB å­—èŠ‚ï¼Œé»˜è®¤ 10GB
 -r              | --mprtt               | **`most-practicle-round-trip-time`** é€‰é¡¹ï¼Œåœ¨å‘é€ä¸‹ä¸€ä¸ªåŒ…ä¹‹å‰å¿…é¡»ç­‰å¾…å¯¹ç«¯å›åº”
 -l              | --pktsize n           | æ¯æ¬¡å‘é€çš„ç¼“å†²åŒºå¤§å° (é»˜è®¤32KB)
 -q 0\|1         | --qtype 0\|1          | å½“ä½¿ç”¨å¤šä¸ª socket è¿›è¡Œä¼ è¾“æ—¶ï¼Œåœ¨streamå†…éƒ¨ä½¿ç”¨å“ªç§ç±»å‹çš„é˜Ÿåˆ—ã€‚0 æŒ‡å®šä½¿ç”¨æ— é”é˜Ÿåˆ—ï¼Œ1 æŒ‡å®šä½¿ç”¨æœ‰é”é˜Ÿåˆ—ï¼ˆmutexé˜Ÿåˆ—ï¼‰
 -d              | --nodelay             | æ‰“å¼€TCPè¿æ¥çš„TCP_NODELAYæ ‡å¿—ï¼ˆç¦ç”¨ Nagle's Algorithmï¼‰
 -a              | --quickack            | æ‰“å¼€TCPè¿æ¥çš„TCP_QUICKACKæ ‡å¿—ï¼ˆç¦ç”¨ DELAYED ACK ç®—æ³•ï¼‰

åœ¨æ·±å…¥ç†è§£å„å‚æ•°å«ä¹‰ä¹‹å‰ï¼Œåº”è¯¥å…ˆäº†è§£ä¸€äº›`fperf`ä¸­çš„ä¸»è¦æ¦‚å¿µã€‚

## Concept

fperf çš„ä¸»è¦å·¥ä½œæ­¥éª¤ä¸ºï¼š

1. æœåŠ¡ç«¯å…ˆäºå®¢æˆ·ç«¯è¿è¡Œï¼Œåˆ›å»ºä¸€ä¸ª `æ§åˆ¶STREAM` å¹¶ç­‰å¾…å®¢æˆ·ç«¯çš„è¿æ¥ï¼›
1. å®¢æˆ·ç«¯åè¿è¡Œï¼Œåˆ›å»ºä¸€ä¸ª `æ§åˆ¶STREAM` å¹¶è¿æ¥åˆ°æœåŠ¡ç«¯çš„æ§åˆ¶STREAMï¼›
1. æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯é€šè¿‡`æ§åˆ¶STREAM`äº¤æ¢è®¾ç½®ï¼›
1. æœåŠ¡ç«¯æ ¹æ®è®¾ç½®åˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ª `æ•°æ®STREAM` å¹¶ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥ï¼›
1. å®¢æˆ·ç«¯åˆ›å»º `æ•°æ®STREAM`å¹¶è¿æ¥æœåŠ¡ç«¯çš„æ•°æ®STREAMï¼›
1. å®¢æˆ·ç«¯æ ¹æ®è®¾ç½®çš„å¤§å°å‘é€æ•°æ®åˆ°æœåŠ¡ç«¯ï¼Œé»˜è®¤å‘é€æ•°æ®å¤§å°ä¸º10GBï¼Œå•æ¬¡å‘é€çš„ç”¨æˆ·æ•°æ®åŒ…å¤§å°ä¸º32KBï¼›
1. æ•°æ®å‘é€æ¥æ”¶å®Œæˆï¼ŒæœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å„è‡ªæ‰“å°è‡ªèº«çš„æŠ¥å‘Šã€‚

fperf å·¥å…·æœ€ä¸»è¦çš„æ ¸å¿ƒç»„ä»¶å°±æ˜¯ `STREAM` å¯¹è±¡.

### STREAM

STREAM å¯¹è±¡æ˜¯ fperf çš„æ ¸å¿ƒå¯¹è±¡ã€‚ä¸€ä¸ª STREAM å¯¹è±¡ä»£è¡¨äº†ä¸€ä¸ªç«¯ç‚¹ï¼ˆendpoint)ï¼Œå’Œä¸ä¹‹è¿æ¥çš„å¦ä¸€ä¸ª STREAM å¯¹è±¡å…±åŒç»„æˆäº†ä¸€ä¸ªè·¨ç½‘ç»œèŠ‚ç‚¹çš„å­—èŠ‚æµçš„é€šé“ã€‚å¯ä»¥ä½¿ç”¨æ ‡å‡†çš„ `read/write` ç³»ç»Ÿè°ƒç”¨è¯»å†™ STREAM å¯¹è±¡ï¼ˆRDMAç±»å‹çš„STREAMé™¤å¤–ï¼‰ã€‚

STREAM å¯¹è±¡çš„å…¸å‹ä½¿ç”¨æ–¹æ³•æ˜¯ï¼š

1. åœ¨æœåŠ¡ç«¯åˆ›å»ºä¸€ä¸ª STREAM å¯¹è±¡ï¼Œè°ƒç”¨å…¶ `bind()` å’Œ `accept()` æ–¹æ³•ä½¿å…¶è¿›å…¥è¢«åŠ¨æ¨¡å¼ç­‰å¾…å®¢æˆ·ç«¯çš„è¿æ¥ï¼›
1. ç„¶ååœ¨å®¢æˆ·ç«¯åˆ›å»ºä¸€ä¸ª STREAM å¯¹è±¡ï¼Œè°ƒç”¨å…¶ `connect()` æ–¹æ³•è¿›å…¥ä¸»åŠ¨æ¨¡å¼è¿æ¥æœåŠ¡ç«¯çš„ STREAM å¯¹è±¡ï¼Œå®Œæˆä¸€ä¸ªæµé€šé“çš„åˆ›å»ºï¼›
1. æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯é€šè¿‡è¯»å†™å„è‡ªçš„ STREAM å¯¹è±¡ï¼Œé€šè¿‡ç½‘ç»œå‘é€æˆ–æ¥æ”¶æ•°æ®ã€‚

æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„ STREAM å¯¹è±¡å®é™…éƒ½æ˜¯ç›¸åŒçš„ç±»å‹ï¼Œåªæ˜¯åœ¨åˆ›å»ºåä½¿ç”¨ä¸åŒçš„å‡½æ•°ä½¿å…¶è¿›å…¥ä¸åŒçš„æ¨¡å¼ã€‚
åœ¨å®ç°ä¸Šï¼Œ`class f_stream_interface` æ˜¯ STREAM å¯¹è±¡çš„é€šç”¨æ¥å£ï¼Œå®ç°äº†é€‚ç”¨äºå„ç§è¿æ¥åè®®çš„é€šç”¨æ–¹æ³•ã€‚`f_stream_tcp` å’Œ `f_stream_udp`ï¼Œä»¥åŠ`f_stream_rdma*` å¯¹è±¡åˆ™ç»§æ‰¿äº `f_stream_interface`ï¼Œå¯¹åº” TCP å’Œ UDP ä»¥åŠ RDMA çš„ç‰¹æ®Šå®ç°ã€‚

ğŸ¶ æ³¨ï¼šRDMA æœ€åŸºæœ¬çš„ç¼–ç¨‹æ¨¡å‹æ˜¯åŸºäº `libibverbs` åº“ã€‚ä¸ä¼ ç»Ÿçš„ `socket` åº“çš„ç¼–ç¨‹æµç¨‹æœ‰å¾ˆå¤§çš„ä¸åŒã€‚ç»è¿‡å¤šå¹´çš„å‘å±•ï¼ŒRDMA ç¤¾åŒºåœ¨ `libibverbs` åº“çš„åŸºç¡€ä¸Šåˆå¼€å‘å‡ºäº†ä¸€äº›å°è£…åº“ï¼Œä¾‹å¦‚ç®¡ç†è¿æ¥çš„ `librdmacma` åº“ï¼Œä»¥åŠä½¿ RDMA ç¼–ç¨‹æµç¨‹ä¸ `socket` ç¼–ç¨‹ç»Ÿä¸€çš„ `rsocket` åº“ã€‚å› æ­¤ï¼Œåœ¨ fperf.hpp å¤´æ–‡ä»¶ä¸­æœ‰ä¸‰ç§ RDMA çš„å®ç°ï¼š`f_stream_rdma_cm`ï¼Œ`f_stream_rdma_rsocket`ï¼Œ`f_stream_rdma_ibverbs`ï¼Œåˆ†åˆ«å¯¹åº” 3 ç§ RDMA APIã€‚åœ¨ç¼–è¯‘æ—¶ä¿®æ”¹ `using f_stream_rdma = f_stream_rdma_ibverbs;` å¯ä»¥å†³å®šä½¿ç”¨å“ªä¸€ç§å®ç°ã€‚

ğŸ¶ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`rsocket api` è™½ç„¶æœ€ç¬¦åˆç†Ÿæ‚‰çš„ `socket` ç¼–ç¨‹çš„ä¹ æƒ¯ã€‚ä½†å®ƒçš„èµ„æ–™ï¼Œä¾‹å­ç¨‹åºä¸å¤šï¼Œç¤¾åŒºä¸å¤Ÿæ´»è·ƒï¼Œè®¨è®ºå’Œæ”¯æŒä¼¼ä¹ä¹Ÿä¸å¤Ÿã€‚å±äºæ¯”è¾ƒå†·é—¨çš„åº“ã€‚RDMA API è¢«è®¾è®¡ä¸ºæ›´è´´è¿‘ç¡¬ä»¶å®ç°çš„ VERBS çš„å½¢å¼ï¼Œæ˜¯ä¸ºäº†èƒ½çµæ´»å®Œå…¨åœ°æ§åˆ¶ç¡¬ä»¶çš„å„é¡¹è®¾ç½®ï¼Œä»¥è¾¾åˆ°é«˜æ€§èƒ½çš„ç›®æ ‡ã€‚å› æ­¤ fperf é»˜è®¤è¿˜æ˜¯é‡‡ç”¨äº† `libibverbs` çš„å®ç°ã€‚

### STREAM çš„å†…éƒ¨ç»“æ„

STREAM å¯¹è±¡å†…éƒ¨ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![fperf.drawio](../diagrams/fperf.drawio.svg)

ä¸€ä¸ªç½‘ç»œæµç”±ä¸¤ä¸ªç›¸äº’è¿æ¥çš„ STRAM å¯¹è±¡ç»„æˆã€‚å…¶ä¸­ä¸€ä¸ªæ˜¯ `ä¸»åŠ¨æ¨¡å¼STREAM`ï¼Œç”±å®¢æˆ·ç«¯åˆ›å»ºï¼›å¦ä¸€ä¸ªæ˜¯ `è¢«åŠ¨æ¨¡å¼STREAM`,ç”±æœåŠ¡ç«¯åˆ›å»ºã€‚
å½“è¿æ¥æˆåŠŸåï¼Œä¸»åŠ¨å’Œè¢«åŠ¨æ¨¡å¼çš„ä¸¤ä¸ª STREAM å¯¹è±¡å…¶å®éƒ½æ²¡æœ‰åŒºåˆ«ï¼Œéƒ½å¯ä»¥é€šè¿‡è¯»å†™å‘å¯¹ç«¯å‘é€æ•°æ®ã€‚

æˆåŠŸè¿æ¥åï¼Œå®¢æˆ·ç«¯æˆ–è€…æœåŠ¡ç«¯å¯ä»¥é€šè¿‡ send/recv å‡½æ•°ï¼Œæˆ–è€… read/write å‡½æ•°åœ¨ STREAM ä¸Šå‘é€å’Œæ¥æ”¶æ•°æ®ã€‚

ä¸€ä¸ª STREAM å¯¹è±¡å†…éƒ¨å¯ä»¥æ”¯æŒå¤šä¸ª socketï¼Œä»¥ä¾¿åˆ©ç”¨å¤šçº¿ç¨‹çš„èƒ½åŠ›æ¥æå‡æ•°æ®ä¼ è¾“æ€§èƒ½ã€‚åœ¨åˆ›å»º STREAM å¯¹è±¡æ—¶å¯ä»¥æŒ‡å®š STREAM å†…éƒ¨çš„ nsockets æ•°é‡ï¼ˆfperf å·¥å…·çš„ `-n` å‚æ•°å°±æŒ‡å®šäº†nsocksæ•°é‡ï¼‰ã€‚nsockets æ•°é‡å°±ä»£è¡¨äº†ä¸€ä¸ª STREAM å¯¹è±¡å†…éƒ¨çš„ sender çº¿ç¨‹çš„æ•°é‡å’Œ socket çš„æ•°é‡ã€‚

å½“è°ƒç”¨ STREAM å¯¹è±¡çš„ accept() æˆ– connect() æ–¹æ³•æ—¶ï¼ŒSTERAM å¯¹è±¡ä¼šæŒ‰ç…§æŒ‡å®šçš„ nsockets æ•°é‡ï¼Œåˆ›å»ºå¯¹åº”æ•°é‡çš„ socketï¼Œå¹¶å°†è¿™äº› socket ä¿å­˜åœ¨å†…éƒ¨çš„ä¸€ä¸ª `Socket Vector`(_vsocks) ç»“æ„ä¸­ã€‚ç„¶åè¿˜ä¼šåˆ›å»ºç›¸åº”æ•°é‡çš„ sender çº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å¯¹åº”ä¸€ä¸ª socketï¼Œè´Ÿè´£é€šè¿‡å¯¹åº”çš„ socket å‘é€æ•°æ®åˆ°å¯¹ç«¯ã€‚

å®¢æˆ·ç«¯æˆ–æœåŠ¡ç«¯ç¨‹åºå¯ä»¥è°ƒç”¨ STREAM å¯¹è±¡çš„ `send_submit()` å‡½æ•°å°†å‘é€è¯·æ±‚æäº¤åˆ° STREAM å†…éƒ¨çš„ä¸€ä¸ªé˜Ÿåˆ—ï¼ˆé˜Ÿåˆ—çš„ç±»å‹å¯ä»¥åœ¨åˆ›å»º STREAM å¯¹è±¡æ—¶æŒ‡å®šä¸ºä¼ ç»Ÿçš„æœ‰é” MUTEX é˜Ÿåˆ—æˆ–æ— é”é˜Ÿåˆ—ï¼‰ã€‚åç»­è¿™äº›è¯·æ±‚å°†ç”± sender çº¿ç¨‹è´Ÿè´£ä»é˜Ÿåˆ—ä¸­å–å‡ºï¼Œå¹¶é€šè¿‡ç½‘ç»œå‘é€ç»™å¯¹ç«¯ã€‚ç¨‹åºå¯ä»¥ä½¿ç”¨`sender_drain()`æ–¹æ³•ç­‰å¾…ï¼Œç›´åˆ°æ‰€æœ‰å·²æäº¤çš„è¯·æ±‚å‘é€å®Œæ¯•ã€‚

å¦‚æœåœ¨ STREAM å†…éƒ¨æœ‰å¤šä¸ª socketsï¼Œå…¶ä¸­æ¯”è¾ƒç‰¹æ®Šçš„æ˜¯ç¬¬ä¸€ä¸ª(ä¿å­˜åœ¨_vsocks[0])ã€‚ç¬¬ä¸€ä¸ª socket è¢«ç”¨åœ¨åŒæ­¥è°ƒç”¨è·¯å¾„ã€‚
ç¨‹åºè°ƒç”¨ send() å‡½æ•°æ—¶ï¼Œåªä½¿ç”¨ç¬¬ä¸€ä¸ªsocketç”¨æ¥åŒæ­¥å‘é€æ•°æ®å¹¶ç­‰åˆ°å‘é€ç»“æŸæ‰ä¼šè¿”å›ã€‚

ä¸å‘é€æ—¶ä¸åŒçš„æ˜¯ï¼ŒSTREAM å¹¶ä¸ä¼šä¸ºæ¥æ”¶åˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Œè€Œæ˜¯é€šè¿‡å¤šè·¯å¤ç”¨ (`poll`)ã€‚åœ¨å¤šä¸ª socket ä¸Šæ¥æ”¶æ•°æ®ã€‚ç”¨æˆ·ç¨‹åºå¯ä»¥è°ƒç”¨ STREAM å¯¹è±¡çš„`recv()`å‡½æ•°ï¼Œæˆ–è€… `read()` ç³»ç»Ÿè°ƒç”¨ (read/write ç³»ç»Ÿè°ƒç”¨åªä»ç¬¬ä¸€ä¸ªsocketè¯»å–/å†™å…¥æ•°æ®) åœ¨ STREAM å¯¹è±¡ä¸Šæ¥æ”¶æ•°æ®ã€‚è¿™äº›è°ƒç”¨éƒ½æ˜¯åŒæ­¥çš„ï¼Œå¯èƒ½ä¼šä½¿å¾—è°ƒç”¨è€…é˜»å¡ï¼ˆä½¿ç”¨recvæ—¶å¯ä»¥æŒ‡å®šä¸€ä¸ªtimeoutå€¼ï¼‰ã€‚

> âš ï¸ æ³¨æ„ï¼š å½“ TCP STREAM å†…éƒ¨å«æœ‰å¤šä¸ª socket ä¸”å‘é€ç«¯ä½¿ç”¨ send_submit() æ—¶ï¼Œå‘é€ç«¯ä½¿ç”¨å¤šçº¿ç¨‹ï¼Œæ¥æ”¶ç«¯ä½¿ç”¨ multiplexingã€‚ç”±äºæ•°æ®åˆ°è¾¾å¯¹ç«¯ socket çš„é¡ºåºæœªçŸ¥ï¼ŒSTREAM ä¸èƒ½ä¿è¯æ¥æ”¶å’Œå‘é€çš„é¡ºåºç›¸åŒã€‚è¿™ç§æƒ…å†µä¸‹ STREAM æ¥æ”¶ç«¯å°†å¤šä¸ª socket ä¸Šæ¥æ”¶åˆ°çš„æ•°æ®æ±‡èšæˆåŒä¸€ä¸ªæ•°æ®æµã€‚ä½†è¿™ç§æ•°æ®æµå¯èƒ½æ˜¯ä¹±åºçš„ï¼Œä»…èƒ½ç”¨äºè¯„ä¼°æ€§èƒ½ï¼Œä¸èƒ½ç”¨äºçœŸæ­£çš„æ•°æ®ä¼ è¾“ã€‚å¦‚æœä¸€å®šè¦ä¿è¯æ•°æ®æµçš„é¡ºåºï¼Œå‘é€ç«¯åªèƒ½ç”¨ nsockets ä¸º 1 æ¥åˆå§‹åŒ– STREAM å¯¹è±¡ï¼Œæˆ–è€…åªç”¨ send() å‡½æ•°å‘é€åŒæ­¥æ•°æ®ï¼Œä»¥ä¿è¯åªæœ‰ä¸€ä¸ª socket (_vsocks[0]) è¢«ç”¨äºæ•°æ®ä¼ è¾“ã€‚

ğŸ¶ fperf ä½¿ç”¨ POSIX `poll` è€Œé Linux `epoll`ï¼Œå› ä¸º fperf æ¯ä¸ª STREAM é»˜è®¤çš„ nsockets ä¸Šé™è¢«é™åˆ¶åœ¨100ä¸ªä»¥å†…ã€‚è€Œå®é™…ä½¿ç”¨ä¸­ï¼ŒSTREAM å¯¹è±¡ä¸€èˆ¬åªåˆ›å»º1ä¸ªï¼Œæœ€å¤šå¯èƒ½åªæœ‰å‡ ä¸ªsocketå°±è¶³å¤Ÿäº†ã€‚åœ¨ socket æ•°é‡ä¸å¤šçš„æƒ…å†µä¸‹ä½¿ç”¨ `poll` å’Œ `epoll` åœ¨æ•ˆç‡ä¸Šçš„å·®åˆ«ä¸å¤§ã€‚

### å‘é€æ•°æ®æ—¶çš„è€ƒè™‘ï¼ˆTCPå’ŒUDPï¼‰

é€šè¿‡ `send_submit()` æˆ–ä½¿ç”¨ `send()` å‡½æ•°ï¼Œéƒ½èƒ½å°†æ•°æ®å‘é€ç»™å¯¹ç«¯ã€‚åŒºåˆ«åœ¨äº `send_submit()` æ˜¯å¼‚æ­¥çš„ï¼Œå¯ä»¥åˆ©ç”¨å¤šçº¿ç¨‹çš„èƒ½åŠ›åŠ é€Ÿæ•°æ®çš„å¤„ç†ã€‚åœ¨CPUå•æ ¸æˆä¸ºç“¶é¢ˆçš„æƒ…å†µä¸‹æˆ–è®¸èƒ½æé«˜å¯¹ç½‘ç»œå¸¦å®½çš„åˆ©ç”¨ã€‚

å¼‚æ­¥å‘é€æ•°æ®å¹¶ä¸æ€»æ˜¯æœ€ä¼˜çš„ã€‚åœ¨ä¼ ç»Ÿçš„åŸºäºä¿¡å·é‡(æˆ–è€…å«MUTEXï¼Œäº’æ–¥é”)çš„é˜Ÿåˆ—ä¸Šï¼Œé”ç«äº‰ï¼Œçº¿ç¨‹çš„åˆ‡æ¢å¯èƒ½ä¼šå¸¦æ¥é¢å¤–çš„æ—¶å»¶ã€‚ä½†æ˜¯è¿™ç§æƒ…å†µéšç€æ“ä½œç³»ç»Ÿçš„æ›´æ–°ï¼Œä»¥åŠç¡¬ä»¶æ¶æ„çš„æå‡ï¼Œå…¶å®åæ˜ å¾—å¹¶ä¸ååˆ†ç³Ÿç³•ã€‚

éšç€å¤„ç†å™¨æ ¸æ•°çš„å¢åŠ ï¼Œä¸ºäº†æ”¹å–„è¿™ç§é”ç«äº‰å’Œçº¿ç¨‹é¢‘ç¹åˆ‡æ¢æƒ…å†µï¼Œè¿‘äº›å¹´æ¯”è¾ƒæµè¡Œçš„æ˜¯ä½¿ç”¨æ— é”é˜Ÿåˆ—ã€‚æ— é”é˜Ÿåˆ—çš„æ¶ˆè´¹è€…çº¿ç¨‹ä¸€èˆ¬æ˜¯åœ¨æŸä¸ªCPUæ ¸ä¸Šç»‘å®šå¹¶å¿™ç­‰æ–°çš„è¯·æ±‚ï¼Œç‹¬å ä¸€ä¸ªæ ¸çš„CPUæ—¶é—´ç‰‡ï¼Œå› æ­¤æ— éœ€åœ¨ç¡çœ å”¤é†’ä¹‹é—´é¢‘ç¹åˆ‡æ¢ï¼ŒèŠ‚çœäº†ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œç³»ç»Ÿè°ƒç”¨çš„æ¬¡æ•°ã€‚

fperf çš„ STREAM åœ¨åˆ›å»ºæ—¶æ”¯æŒæœ‰é”é˜Ÿåˆ—å’Œæ— é”é˜Ÿåˆ—ï¼ˆfperf å·¥å…·çš„ `-q` å‚æ•°ï¼‰ã€‚å¯ä»¥å°è¯•ä¸åŒçš„é€‰é¡¹ä»¥è¯„ä¼°å„è‡ªçš„æ€§èƒ½ã€‚

> âš ï¸ æ³¨æ„ï¼šfperf ç›®å‰çš„æ— é”é˜Ÿåˆ—ä¸»è¦ copy å¹¶ä¿®æ”¹è‡ª 'folly' é¡¹ç›®çš„ `ProducerConsumerQueue`ã€‚ç›®å‰åªæ”¯æŒä¸€ä¸ª Producer å’Œä¸€ä¸ª Consumerã€‚
> åœ¨ fperf å·¥å…·ä¸­ï¼Œç”±äºä¸»ç¨‹åºçš„å”¯ä¸€å¤„ç†å°±æ˜¯ä¸åœç”¨ `send_submit()` æäº¤è¯·æ±‚ï¼Œå› æ­¤ fperf å·¥å…·ä½¿ç”¨æ— é”é˜Ÿåˆ—çš„æ•ˆæœé¢„æœŸå’Œç›´æ¥çš„åŒæ­¥è°ƒç”¨ `send()` ç±»ä¼¼ã€‚

### MPRTTï¼ŒNODELAY, QUICKACK

#### MPRTT

fperf `-r` å‚æ•°ï¼Œç»Ÿè®¡ ROUND TRIP çš„æ—¶é—´ã€‚æŒ‡å®š `-r` å‚æ•°åï¼Œå‘é€ç«¯åœ¨æ¯æ¬¡å‘é€ä¸€æ¬¡æ•°æ®åï¼Œä¼šç­‰å¾…å¯¹ç«¯è¿”å›ä¸€ä¸ªACKï¼Œç„¶åæ‰ç»§ç»­å‘é€ä¸‹ä¸€ä¸ªæ•°æ®ã€‚å¦‚æœç­‰å¾…ACKè¶…æ—¶ï¼ˆUDPå¯èƒ½ä¸¢åŒ…ï¼‰ï¼Œåˆ™å‘é€ç«¯ä¼šé‡æ–°å‘é€æ•°æ®ï¼Œç„¶åç»§ç»­ç­‰å¾…ACKï¼Œç›´åˆ°é‡è¯•å¤±è´¥10æ¬¡ã€‚è€Œæ¥æ”¶ç«¯åœ¨æ¯æ¥æ”¶åˆ°ä¸€ä¸ªæ•°æ®åï¼Œä¼šå‘é€ä¸€ä¸ªACKã€‚

ä¸å¯é¿å…åœ°ï¼Œç”±äºUDPä¸¢åŒ…çš„å¯èƒ½æ€§å’Œ fperf çš„é‡è¯•è®¾å®šã€‚å½“ `-r` å‚æ•°æŒ‡å®šæ—¶ï¼Œæœ‰å¯èƒ½ç”±äºæ•°æ®åœ¨ç½‘ç»œä¸¢å¤±ï¼Œæˆ–è€…ACKä¸¢å¤±ï¼ŒSTREAM å¯¹è±¡ä¼šå°è¯•é‡å‘æ•°æ®ï¼Œå¯¼è‡´æœåŠ¡ç«¯å®é™…æ¥æ”¶åˆ°çš„æ•°æ®é‡å’Œå‘½ä»¤è¡ŒæŒ‡å®šçš„æ•°æ®é‡ä¸ä¸€æ ·ã€‚åœ¨ä¸¥è‚ƒçš„åœºåˆé‡Œï¼Œåº”è¯¥å®ç°æŸç§flow controlï¼ˆsliding windowï¼‰ç®—æ³•æ¥è¿›è¡Œå¤„ç†ã€‚ä½†åœ¨ fperf ä¸­ï¼Œä¿ç•™è¿™ç§ä¸ä¸€è‡´ï¼Œåè€Œå¯ä»¥ç”¨äºè®¡ç®—é‡è¯•çš„æ¬¡æ•°ä»¥åŠä¸¢åŒ…ç‡ã€‚

ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œå®¢æˆ·ç«¯ä½¿ç”¨ UDP é»˜è®¤å‘é€ 10GB (**10737418240B**) çš„æ•°æ®åˆ° fperf æœåŠ¡ç«¯ã€‚è€ŒæœåŠ¡ç«¯å®é™…æ¥æ”¶åˆ°(**10737451008B**)ï¼Œå¤šæ”¶åˆ°äº†32768Bï¼Œè¯´æ˜æœ‰ä¸€ä¸ªACKä¸¢å¤±ï¼Œå®¢æˆ·ç«¯é‡è¯•å‘é€è¿‡ä¸€æ¬¡æ•°æ®ã€‚

å®¢æˆ·ç«¯ç»Ÿè®¡ä¸­çš„ "received"ï¼Œè¡¨ç¤ºæ”¶åˆ°çš„ACKçš„æ€»å­—èŠ‚æ•°ã€‚ç”±äº fperf çš„ ACK ä¸º1å­—èŠ‚å¤§å°ï¼ˆåé¢è®²è§£åŸå› ï¼‰327680B è¡¨ç¤ºæ€»å…±æ”¶åˆ°äº† 327680 ä¸ªACKã€‚327680 * 32768 = 10GBã€‚

```bash
# å®¢æˆ·ç«¯ç»Ÿè®¡
$ ./fperf -c localhost -r -u
UDP STREAM 0 127.0.0.1:33466 => 127.0.0.1:49996 pkt_size=32768B sync(no-queue) nsockets=1
sent      : 10240MB(10.00GB 10737418240B) in 7.86s. (bw: 1.27GB/s 10Gbit/s)
received  : 0MB(0.00GB 327680B)
mprtt     : avg=23.97us    min=22.43us    max=178.28us

# æœåŠ¡ç«¯ç»Ÿè®¡
$ ./fperf -s

Server listening .... new UDP connection from 0.0.0.0:33466. pkt_size(32768B)
received : 10240MB(10.00GB 10737451008B) in 7.84s. (bw: 1.28GB/s 10Gbit/s)
mprtt    : avg=23.92us    min=15.13us    max=200.49us

Server listening .... 
```

#### WHY MPRTT

ä¸åŒäº TCP åè®®æœ¬èº«åœ¨æ¡æ‰‹é˜¶æ®µçš„ **RTT** (Round Trip Time) æ—¶é—´ï¼Œfperf çš„ **MPRTT** (Most Practicle Round Trip Time) æ—¶é—´ä¹Ÿåº”ç”¨åœ¨ UDP ä¸Šï¼Œæ—¨åœ¨åæ˜ æœ€ä¸ºè´´è¿‘ç”¨æˆ·åº”ç”¨ç¨‹åºæ‰€ç›´æ¥æ„Ÿå—åˆ°çš„æ—¶å»¶ã€‚

å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªè¾ƒå¤§çš„æ•°æ®åŒ…ï¼ŒæœåŠ¡å™¨å‘å›ä¸€ä¸ªè¾ƒå°çš„ACKåŒ…ï¼Œè¿™æ˜¯ç°å®ä¸­æ¯”è¾ƒå¸¸ç”¨çš„ä¸€ç§é€šè®¯åºåˆ—ã€‚MPRTT ä¸»è¦è¯„ä¼°è¿™ç§æƒ…å†µä¸‹çš„æ—¶å»¶ã€‚

è¿™ç§æ¨¡å¼æ‰€é€ æˆçš„ç½‘ç»œæ¶ˆè€—å¾ˆå¤§ã€‚æ¯”å¦‚ä½¿ç”¨TCP IPV4ç½‘ç»œæ—¶ï¼ŒTCP HEADERæœ‰40å­—èŠ‚ã€‚å‡è®¾ç”¨æˆ·æ•°æ®ACKåªæœ‰ä¸€ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆæ•´ä¸ªIPåŒ…41å­—èŠ‚ï¼Œå…¶ä¸­åªæœ‰1ä¸ªå­—èŠ‚çš„PAYLOADã€‚è¿™æ ·å‘é€å’Œæ¥æ”¶æ•°æ®ä¼šé€ æˆä¸¥é‡çš„èµ„æºæµªè´¹å’Œç½‘ç»œæ‹¥å µã€‚å¦‚æœä½¿ç”¨UDPåè®®ï¼Œæƒ…å†µç¨å¾®ä¼šå¥½ä¸€äº›ï¼Œä½†UDPçš„IP HEADERä¹Ÿæœ‰20å­—èŠ‚ï¼Œå› æ­¤è¿˜æ˜¯ä¼šé€ æˆå¸¦å®½æµªè´¹ã€‚

ä¸ºäº†æ”¾å¤§è¿™ç§æƒ…å†µï¼Œå½“ `-r` å‚æ•°è¢«æŒ‡å®šçš„æ—¶å€™ï¼Œfperf å‘é€çš„ ACK è¢«è®¾ç½®ä¸º1ä¸ªå­—èŠ‚ã€‚

å®é™…ä¸Šï¼Œä½¿ç”¨TCPåè®®æ—¶ï¼Œæƒ…å†µå¯èƒ½è¿˜ä¼šæ›´ç³Ÿç³•ã€‚å› ä¸ºåœ¨80å¹´ä»£åˆæœŸå¼•å…¥çš„ä¸¤ä¸ªä¼˜åŒ–ç®—æ³•ï¼š**Nagle's Algorithm** å’Œ **Delayed ACK**ï¼Œåç»­è¢«è¯æ˜æ˜¯äº’æ–¥çš„ã€‚å¦‚æœä¸¤ä¸ªç®—æ³•åŒæ—¶æ‰“å¼€ (å¤§å¤šæ•°æƒ…å†µä¸‹ä¸¤è€…éƒ½æ˜¯é»˜è®¤æ‰“å¼€çš„)ï¼Œå¯èƒ½ä¼šå¯¼è‡´æŒç»­çš„200ms~500msçš„é«˜æ—¶å»¶ã€‚

#### Nagle's Algorithm å’Œ Delayed ACK

ç®€å•æ¥è¯´ï¼ŒNagle's Algorithm æ˜¯å¸Œæœ›é€šè¿‡èšåˆå¤šä¸ªå°çš„TCPå‘é€è¯·æ±‚åˆ°ä¸€æ¬¡ç½‘ç»œä¼ è¾“ä¸­ï¼Œä»¥å¢åŠ å¯¹ç½‘ç»œå¸¦å®½çš„åˆ©ç”¨ã€‚è€Œ Delayed ACK åˆ™æ˜¯å¸Œæœ›èšåˆå¤šä¸ª ACK åˆ°ä¸€æ¬¡ç½‘ç»œä¼ è¾“ä¸­ï¼Œä»¥æé«˜ç½‘ç»œæ€§èƒ½ã€‚

ç„¶è€Œä¸å¹¸çš„æ˜¯ï¼Œä¸¤ä¸ªç®—æ³•æ¥è‡ªäºä¸¤ä¸ªä¸ç›¸å…³çš„å®ä½“ï¼ˆNagleå’ŒBerkeley)ï¼Œä¸”å·®ä¸å¤šåŒä¸€æ—¶é—´è¿›å…¥äº†TCPæ ‡å‡†ã€‚ä»–ä»¬äº’ç›¸ä¸çŸ¥é“å¯¹æ–¹çš„å·¥ä½œã€‚ç›´åˆ°ä¸¤ä¸ªç®—æ³•è¢«å¤§é‡çš„å®ç°æ‰å‘ç°ä¸¤è€…çš„å·¥ä½œæ–¹å¼å®é™…æ˜¯äº’æ–¥çš„ï¼Œå¯èƒ½ä¼šå¯¼è‡´å‘é€å’Œæ¥æ”¶ç«¯ç›¸äº’ç­‰å¾…ï¼Œç›´åˆ°è¶…æ—¶ã€‚

è¿™ä¸¤è€…éƒ½å¯¹å¸¦å®½å‹å¥½ï¼Œæ˜¯TCPæµæ§å’Œæ‹¥å¡æ§åˆ¶çš„ä¸€éƒ¨åˆ†ï¼Œå…¶ç›®çš„æ˜¯å°½é‡å æ»¡ç½‘ç»œå¸¦å®½ã€‚è€Œä»–ä»¬å¯¹äºæ—¶å»¶æ•æ„Ÿçš„åº”ç”¨å´ä¸å¤Ÿå‹å¥½ã€‚æ‰€ä»¥å¯¹äºä¸¥æ ¼è¦æ±‚ä½æ—¶å»¶çš„åº”ç”¨ï¼ŒUDPå¯èƒ½æ›´ä¸ºåˆé€‚ã€‚

#### Nagle's Algorithm

å‚è§ç»´åŸºç™¾ç§‘ [Nagle's algorithm](https://en.wikipedia.org/wiki/Nagle%27s_algorithm)ã€‚fperf å…è®¸ä½¿ç”¨ `-d --nodelay` å‚æ•°ç¦ç”¨TCPçš„ Nagle's Algorithmã€‚

#### TCP delayed acknowledgment

å‚è§ç»´åŸºç™¾ç§‘ [TCP delayed acknowledgment](https://en.wikipedia.org/wiki/TCP_delayed_acknowledgment)ã€‚fperf å…è®¸ä½¿ç”¨ `-a --quickack` å‚æ•°ç¦ç”¨TCPçš„ Delayed ACK åŠŸèƒ½ã€‚

### æ—¶å»¶çš„è®¡ç®—

STREAM å¯¹è±¡çš„åº•å±‚ä½¿ç”¨ read() å’Œ write() ç³»ç»Ÿè°ƒç”¨åœ¨ socket ä¸Šè¯»å†™æ•°æ®ã€‚STREAM å¯¹è±¡éƒ½æ˜¯ä½¿ç”¨çš„ NONBLOCK socketã€‚å› æ­¤è¯»å†™å¯èƒ½å› ä¸ºå½“å‰æ— æ•°æ®å¯è¯»è€Œç«‹å³è¿”å› `EAGAIN` æˆ–è€… `EWOULDBLOCK`ï¼Œä¸ä¼šå¯¹ STREAM å¯¹è±¡é€ æˆé˜»å¡ã€‚

> **æ³¨æ„**ï¼Œread() å’Œ write() è™½ç„¶ä¸ä¼šå¯¹ STREAM å¯¹è±¡é€ æˆé˜»å¡ï¼Œä½† STREAM å¯¹è±¡å¯¹æ­¤è¿›è¡Œäº†å¤„ç†ï¼Œå› æ­¤æ›´ä¸Šå±‚çš„ä½¿ç”¨ STREAM å¯¹è±¡çš„ç”¨æˆ·ç¨‹åºå¯èƒ½ä¼šé˜»å¡ã€‚ä¸ºæ­¤ STREAM å¯¹è±¡ç»™ send() å’Œ recv() ä»¥åŠ send_submit() æ–¹æ³•éƒ½æä¾›äº† `timeout` å‚æ•°ã€‚æŒ‡å®š timeout=0 æ—¶è¡¨ç¤ºæ— é˜»å¡è°ƒç”¨ï¼Œtimeout=-1 è¡¨ç¤ºä¸€ç›´é˜»å¡ç›´åˆ°æˆåŠŸæˆ–å‡ºé”™ï¼Œå…¶ä»–æ•°å­—åˆ™æ˜¯ä»¥æ¯«ç§’ä¸ºå•ä½è®¾ç½®çš„ç­‰å¾…æ—¶é—´ã€‚

å•æ¬¡å‘é€æˆ–æ¥æ”¶çš„æ—¶å»¶ï¼š

| ç±»å‹ | æŠ¥è¡¨æ˜¾ç¤º | è®¡ç®— |
|-----|---------|-----|
|å•æ¬¡å‘é€æ—¶å»¶| å®¢æˆ·ç«¯æ˜¾ç¤ºçš„`laytency` | ä» write() ç³»ç»Ÿè°ƒç”¨å¼€å§‹ï¼Œç›´åˆ°å…¶è¿”å›ã€‚å¦‚æœå› ä¸ºEAGAINæˆ–è€…EWOULDBLOCKè¿”å›ï¼Œåˆ™poll()ç­‰å¾…çš„æ—¶é—´ä¹Ÿç®—åœ¨å‘é€æ—¶å»¶å†…|
|å•æ¬¡æ¥æ”¶æ—¶å»¶| æœåŠ¡ç«¯æ˜¾ç¤ºçš„`laytency` | ç”±äº fperf çš„æ¥æ”¶å‡½æ•°ä½¿ç”¨poll()è¿›è¡Œäº†å¤šè·¯å¤ç”¨ï¼Œä» poll() ç³»ç»Ÿè°ƒç”¨å¼€å§‹ï¼Œç›´åˆ°åç»­çš„ read() è¿”å›éƒ½è®¡å…¥æ¥æ”¶æ—¶å»¶ã€‚å¦‚æœread()å› ä¸ºEAGAINæˆ–è€…EWOULDBLOCKè¿”å›ï¼Œåˆ™åç»­poll()é”™è¯¯å¤„ç†ç­‰å¾…çš„æ—¶é—´ä¹Ÿç®—åœ¨æ¥æ”¶æ—¶å»¶å†…ã€‚|
|å•æ¬¡MPRTTå‘é€æ—¶å»¶| å®¢æˆ·ç«¯æ˜¾ç¤ºçš„`mprtt` | ä» write() ç³»ç»Ÿè°ƒç”¨å¼€å§‹ï¼Œç›´åˆ°æˆåŠŸæ¥æ”¶åˆ°å¯¹æ–¹1å­—èŠ‚çš„ ack åè¿”å›ã€‚å¦‚æœå‘ç”Ÿé‡è¯•ï¼Œåˆ™é‡è¯•çš„æ—¶é—´ä¹Ÿè®¡ç®—åœ¨å•æ¬¡mprttå‘é€æ—¶å»¶å†…ã€‚|
|å•æ¬¡MPRTTæ¥æ”¶æ—¶å»¶| æœåŠ¡ç«¯æ˜¾ç¤ºçš„`mprtt` | ä»poll()å¼€å§‹ï¼Œç›´åˆ°åç»­çš„ read() å’Œ write() 1å­—èŠ‚çš„ACKéƒ½æˆåŠŸè¿”å›ä¸ºæ­¢ã€‚MPRTTçš„æ¥æ”¶ç«¯ä¸è¿›è¡Œé‡è¯•ã€‚|
|å¼‚æ­¥å‘é€æäº¤æ—¶å»¶|lat_submit|é˜Ÿåˆ—ç­‰å¾…æ—¶å»¶ã€‚å‘é€ç«¯çš„ sender é˜Ÿåˆ—æ·±åº¦æ˜¯å¯é…ç½®çš„ã€‚fperf é»˜è®¤é˜Ÿåˆ—å¤§å°å¯å®¹çº³10000ä¸ªè¯·æ±‚ã€‚å½“é˜Ÿåˆ—å……æ»¡è€Œæœªæ¥å¾—åŠå¤„ç†æ—¶ï¼Œæäº¤å‡½æ•°å¯èƒ½ä¼šé˜»å¡è¿›ç¨‹ã€‚lat_submit ä»ç”¨æˆ·è°ƒç”¨ send_submit() å°è¯•æäº¤å¼€å§‹ï¼Œç›´åˆ°æˆåŠŸæäº¤è¯·æ±‚ä¸ºæ­¢çš„æ—¶é—´ã€‚|

ğŸ¶ **æ³¨æ„ï¼š**

- é»˜è®¤æƒ…å†µä¸‹ï¼Œfperf åªåˆ›å»ºä¸€ä¸ª socket å¹¶ä½¿ç”¨åŒæ­¥æ¨¡å¼ send() å‘é€æ•°æ®ã€‚åœ¨ --nsockets å¤§äº 1 çš„æ—¶å€™ï¼Œfperf æ‰ä¼šä½¿ç”¨ send_submit() å¼‚æ­¥å‘é€æ•°æ®ï¼ŒæŠ¥å‘Šä¸­æ‰ä¼šæ˜¾ç¤º lat_submitã€‚
- å½“ä½¿ç”¨ LOCKFREE QUEUE çš„æƒ…å†µä¸‹ (`--qtype 0`)ï¼Œç”±äºå½“å‰çš„æ— é”é˜Ÿåˆ—åªæ”¯æŒä¸€ä¸ªconsumerçº¿ç¨‹å’Œä¸€ä¸ªproducerçº¿ç¨‹ï¼Œå› æ­¤ nsockets åœ¨ STREAM å¯¹è±¡å†…éƒ¨è¢«é™åˆ¶ä¸º1ã€‚è™½ç„¶ nsockets è¢«é™åˆ¶ä¸º1ï¼Œä½†å½“æ— é”é˜Ÿåˆ—è¢«æŒ‡å®šçš„æƒ…å†µä¸‹ fperf å§‹ç»ˆä½¿ç”¨ send_submit() å¼‚æ­¥å‘é€æ•°æ®ï¼Œå› æ­¤æŠ¥å‘Šä¸­å§‹ç»ˆä¼šæ˜¾ç¤º lat_submitã€‚
- â€˜latencyâ€™ åªåæ˜ ç½‘ç»œçš„æ—¶å»¶ï¼Œè€Œä¸ååº”æ•°æ®åœ¨ STREAM é˜Ÿåˆ—ä¸­ç­‰å¾…çš„æ—¶é—´ã€‚å½“ --nsockets å¤§äº 1 æˆ–ä½¿ç”¨æ— é”é˜Ÿåˆ—çš„æ—¶å€™ï¼Œfperf ä½¿ç”¨å¼‚æ­¥æ¨¡å¼å‘é€æ•°æ®ã€‚æ­¤æ—¶ï¼Œå•ä¸ªæ•°æ®æ€»çš„å‘é€æ—¶å»¶ï¼Œåº”è¯¥æ˜¯ lat_submit + latency(æˆ–mprtt) çš„å’Œã€‚

### BLOCK å’Œ NONBLOCK

NONBLOCKING çš„ socket æ˜¯ä¸€é¡¹å¯èƒ½æé«˜æœåŠ¡å™¨æ€§èƒ½çš„åˆ©å™¨ã€‚NONBLOCKING çš„ socket ä¸ä¼šé˜»å¡ï¼Œä¸€æ—¦ read() é‡åˆ°æš‚æ—¶æ²¡æœ‰æ•°æ®çš„æƒ…å†µï¼Œæˆ–è€… write() é‡åˆ°ç½‘ç»œæš‚æ—¶ä¸å¯ç”¨æ—¶ï¼Œä¼šç«‹å³è¿”å› EAGAIN æˆ–è€… EWOULDBLOCK ï¼ˆåœ¨å¾ˆå¤šå®ç°ä¸­ï¼ŒåŒ…æ‹¬Linuxï¼Œéƒ½å°† EAGAIN å’Œ EWOULDBLOCK å®šä¹‰ä¸ºåŒä¸€ä¸ªæ•°å­— 11ï¼‰ã€‚

è¿™æ ·ï¼Œç¨‹åºå°±æœ‰æœºä¼šåœ¨ read()/write() è¿”å›å¤±è´¥åå†è°ƒç”¨ poll()/select()/epoll() ç­‰å¾…æ–°çš„æ•°æ®ã€‚è€Œä¸å¿…åœ¨æ¯æ¬¡æ¥æ”¶æˆ–å‘é€å‰éƒ½è°ƒç”¨ poll()ã€‚å¯¹äº fperf è¿™ç§ä¸€ç›´å‘é€æ‰¹é‡æ•°æ®çš„ç¨‹åºï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œsocket ä¸Šå¯èƒ½ç›´æ¥å°±èƒ½æˆåŠŸè¯»å–è€Œæ— éœ€ç­‰å¾…ï¼Œå› æ­¤å¯ä»¥å‡å°‘å¾ˆå¤špoll()ç³»ç»Ÿè°ƒç”¨ã€‚

fperf ä¸­è¯•å›¾ä½¿ç”¨ NONBLOCKING çš„ socket é€‰é¡¹æ¥æé«˜æ•°æ®å‘é€æ¥æ”¶çš„æ•ˆç‡:

```cpp
if (fcntl(fd, F_SETFL, flags | O_NONBLOCK) == -1) {
    ERR("failed to set socket(%d) flag.", fd);
    return -1;
}
```

åªåœ¨æ²¡æœ‰æ•°æ®æ—¶æ‰è°ƒç”¨poll():

```cpp
nr = freadn(sock, buf, count);
if(nr==0 && errno==EAGAIN && timeout) {
    if(!waitin(sock, timeout)) {
        errno = ETIMEDOUT;
        return -1;
    }
}
// freadn() ä¸­ä½¿ç”¨äº† read() ç³»ç»Ÿè°ƒç”¨
// waitin() ä¸­ä½¿ç”¨äº† poll() ç³»ç»Ÿè°ƒç”¨
```

### n streams

é»˜è®¤æƒ…å†µä¸‹ï¼ˆå¤§å¤šåº”ç”¨ä¹Ÿæ˜¯å¦‚æ­¤ï¼‰ï¼Œfperf åªä¼šåˆ›å»ºä¸€ä¸ª STREAM å¯¹è±¡ç”¨äºå‘é€å’Œæ¥æ”¶æµ‹è¯•æ•°æ®ï¼ˆä¸¥æ ¼è¯´è¿˜ä¼šåˆ›å»ºä¸€ä¸ªæ§åˆ¶STREAMç”¨äºäº¤æ¢è®¾ç½®) ã€‚

å¦‚æœä½¿ç”¨ `-t` å‚æ•°ï¼Œåˆ™ fperf ä¼šåˆ›å»ºå¤šä¸ª STREAM å¯¹è±¡ï¼Œå¹¶ä¸ºæ¯ä¸ª STEAM å¯¹è±¡å¯åŠ¨ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹æ¥å‘é€æµ‹è¯•æ•°æ®ã€‚è¿™ç§æƒ…å†µä¸»è¦ç”¨æ¥è¯„ä¼°å¤šä¸ªåº”ç”¨æˆ–è€…ä¸€ä¸ªåº”ç”¨ä½¿ç”¨å¤šä¸ªç«¯å£å…±äº«åŒä¸€ä¸ªç½‘ç»œæ—¶çš„æƒ…å†µã€‚

æ¯ä¸ª STREAM å¯¹è±¡ç›‘å¬ä¸åŒçš„ç«¯å£ã€‚ä¾‹å¦‚æŒ‡å®šäº† `-t 5`ï¼Œåˆ™ fperf åˆ›å»º 5 ä¸ª STREAMï¼Œåˆ†åˆ«ä½¿ç”¨ç«¯å£ `RECVPORT` è‡³ `RECVPORT+4`ã€‚`RECVPORT`é¢„å®šä¹‰ä¸º`28444`ï¼Œåªèƒ½åœ¨ç¼–è¯‘æ—¶æ”¹å˜ï¼Œä¸€èˆ¬ä¸ä¼šå†²çªï¼Œå› æ­¤æš‚æ— è®¡åˆ’å¢åŠ å‘½ä»¤è¡Œå‚æ•°æŒ‡å®šç«¯å£ã€‚

å¤šä¸ª STREAM å¯¹è±¡çš„å¸¦å®½å’Œæ—¶å»¶æ•°æ®æœ€ç»ˆä¼šè¢«æ±‡æ€»åˆ°æŠ¥å‘Šä¸­ã€‚æ­¤å¤–ï¼Œå½“å¤šä¸ª STREAM è¢«ç”¨äºå‘é€æ¥æ”¶æ•°æ®æ—¶ï¼Œå®¢æˆ·ç«¯ä¼šé¢å¤–æ˜¾ç¤ºæ¯ä¸ª STREAM çš„ç»Ÿè®¡ä¿¡æ¯ï¼š

```bash=
$ ./fperf -c localhost -q0 -t2 -r
TCP STREAM 4 127.0.0.1:34252 => 127.0.0.1:28444 pkt_size=32768B sync(no-queue) nsockets=1
TCP STREAM 5 127.0.0.1:47436 => 127.0.0.1:28445 pkt_size=32768B sync(no-queue) nsockets=1

sent      : 20480MB(20.00GB 21474836480B) in 7.26s. (bw: 2.76GB/s 22Gbit/s)
received  : 1MB(0.00GB 655360B)
mprtt     : avg=22.15us    min=17.32us    max=201.13us
lat_submit: avg=15429ns    min=43ns    max=175861ns

Per Stream:
  stream 4 : avg=21.95us    min=17.32us    max=199.79us sent: 10.00GB  bw: 11Gbit/s
  stream 5 : avg=22.35us    min=18.10us    max=201.13us sent: 10.00GB  bw: 11Gbit/s
```

## å‚æ•°å›çœ‹

 çŸ­æ ¼å¼           | é•¿æ ¼å¼                 | è§£é‡Š
 ----------------|-----------------------|--------------------------
 -s              | --server              | ä½¿ fperf ä»¥æœåŠ¡ç«¯æ¨¡å¼è¿è¡Œ
 -c server_name  | --client server_name  | ä½¿ fperf ä»¥å®¢æˆ·ç«¯æ¨¡å¼è¿è¡Œ
 -n n            | --nsockets n          | åŒä¸€ä¸ªstreamé‡Œå¼€å¯`n`ä¸ª`socket`
 -R              | --rdma                | ä½¿ç”¨`RDMA`åè®®ï¼ˆé»˜è®¤ä½¿ç”¨`TCP`åè®®)
 -D devname      | --rdmadev devname     | ä½¿ç”¨`RDMA`åè®®æ—¶ä½¿ç”¨çš„è®¾å¤‡åï¼ˆé»˜è®¤ä½¿ç”¨ç¬¬ä¸€ä¸ªè¢«å‘ç°çš„RDMAè®¾å¤‡ï¼‰
 -u              | --udp                 | ä½¿ç”¨`UDP`åè®®ï¼ˆé»˜è®¤ä½¿ç”¨`TCP`åè®®)
 -m n            | --mb n                | æ€»å…±ä¼ è¾“ n MB å­—èŠ‚ï¼Œé»˜è®¤ 10GB
 -r              | --mprtt               | **`most-practicle-round-trip-time`** é€‰é¡¹ï¼Œåœ¨å‘é€ä¸‹ä¸€ä¸ªåŒ…ä¹‹å‰å¿…é¡»ç­‰å¾…å¯¹ç«¯å›åº”
 -l              | --pktsize n           | æ¯æ¬¡å‘é€çš„ç¼“å†²åŒºå¤§å° (é»˜è®¤32KB)
 -q 0\|1         | --qtype 0\|1          | å½“ä½¿ç”¨å¤šä¸ª socket è¿›è¡Œä¼ è¾“æ—¶ï¼Œåœ¨streamå†…éƒ¨ä½¿ç”¨å“ªç§ç±»å‹çš„é˜Ÿåˆ—ã€‚0 æŒ‡å®šä½¿ç”¨æ— é”é˜Ÿåˆ—ï¼Œ1 æŒ‡å®šä½¿ç”¨æœ‰é”é˜Ÿåˆ—ï¼ˆmutexé˜Ÿåˆ—ï¼‰
 -d              | --nodelay             | æ‰“å¼€TCPè¿æ¥çš„TCP_NODELAYæ ‡å¿—ï¼ˆç¦ç”¨ Nagle's Algorithmï¼‰
 -a              | --quickack            | æ‰“å¼€TCPè¿æ¥çš„TCP_QUICKACKæ ‡å¿—ï¼ˆç¦ç”¨ DELAYED ACK ç®—æ³•ï¼‰
